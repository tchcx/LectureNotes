# reporter.py
from jinja2 import Environment, FileSystemLoader
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Any, Optional

def _format_time(timestamp: Optional[str]) -> str:
    """Converts various timestamp formats into a consistent string."""
    if not timestamp:
        return ""

    # List of possible formats to try parsing
    formats_to_try = [
        "%Y:%m:%d %H:%M:%S",          # EXIF
        "%Y-%m-%d %H:%M:%S UTC",      # Scraper request time
        "%a, %d %b %Y %H:%M:%S %Z",  # HTTP Header (e.g., Last-Modified)
    ]

    for fmt in formats_to_try:
        try:
            dt_obj = datetime.strptime(timestamp, fmt)
            # Return a consistent, two-line format for maps
            return dt_obj.strftime("%Y-%m-%d\n%H:%M:%S")
        except (ValueError, TypeError):
            continue
    
    return timestamp # Return original string if no format matches

def create_html_report(
    geotagged_images: List[Dict[str, Any]],
    report_filename: str = "report.html",
    summary_map_filename: str = "summary_map.html"
):
    """Generates an HTML report and a summary map from image data."""
    template_dir = Path("templates")
    if not template_dir.is_dir():
        print("ðŸ”´ Error: 'templates' directory not found.")
        return

    env = Environment(loader=FileSystemLoader(template_dir))

    # --- Prepare Data for Templates ---
    map_locations = []
    report_items = []

    for item in geotagged_images:
        # Prepare location data for the summary map
        map_time = _format_time(
            item.get("datetime_original") or item.get("last_modified") or item.get("request_time")
        )
        map_locations.append({
            "lon": item["coords"]["lon"],
            "lat": item["coords"]["lat"],
            "time": map_time
        })

        # Prepare and format data for the detailed report table
        report_item = item.copy()
        report_item["datetime_original"] = _format_time(item.get("datetime_original")).replace("\n", " ")
        report_item["last_modified"] = _format_time(item.get("last_modified")).replace("\n", " ")
        report_item["request_time"] = _format_time(item.get("request_time")).replace("\n", " ")
        report_item["image_path"] = Path(item["image_path"]).name # Show only filename in report
        report_items.append(report_item)

    # --- Generate Summary Map Page ---
    try:
        summary_template = env.get_template("summary_map.html")
        summary_html = summary_template.render(locations=map_locations)
        with open(summary_map_filename, "w", encoding="utf-8") as f:
            f.write(summary_html)
        print(f"ðŸŸ¢ Summary map generated: {summary_map_filename}")
    except Exception as e:
        print(f"ðŸ”´ Error writing summary map file: {e}")

    # --- Generate Detailed Report Page ---
    try:
        report_template = env.get_template("report_template.html")
        html_content = report_template.render(
            image_data=report_items,
            summary_map_link=summary_map_filename
        )
        with open(report_filename, "w", encoding="utf-8") as f:
            f.write(html_content)
        print(f"ðŸŸ¢ Detailed report generated: {report_filename}")
    except Exception as e:
        print(f"ðŸ”´ Error writing detailed report file: {e}")
