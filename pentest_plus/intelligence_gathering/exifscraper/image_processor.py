# image_processor.py
import exif
from pathlib import Path
from typing import List, Dict, Any

def _dms_to_dd(gps_coords: tuple, gps_ref: str) -> float:
    """Converts GPS Degrees, Minutes, Seconds to Decimal Degrees."""
    d, m, s = gps_coords
    dd = d + m / 60 + s / 3600
    if gps_ref in ("S", "W"):
        dd *= -1
    return dd

def process_images(images: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """Processes a list of image files to extract EXIF and header data."""
    processed_data = []
    for image_info in images:
        path: Path = image_info["path"]
        print(f"ðŸŸ£ Processing: {path}")
        try:
            with open(path, "rb") as img_file:
                exif_img = exif.Image(img_file)

            # Base data from scraper
            report_item = {
                "image_path": str(path),
                "sha256sum": image_info["sha256sum"],
                "source_url": image_info["source_url"],
                "server": image_info["headers"].get("Server"),
                "last_modified": image_info["headers"].get("Last-Modified"),
                "request_time": image_info["request_time"],
            }

            if exif_img.has_exif:
                print(f"  ðŸŸ¢ Found EXIF Data for {path}")
                # Update report with any available EXIF tags
                report_item.update({
                    "datetime_original": exif_img.get("datetime_original"),
                    "make": exif_img.get("make"),
                    "model": exif_img.get("model"),
                    "software": exif_img.get("software"),
                })

                if "gps_latitude" in exif_img.list_all():
                    lat = _dms_to_dd(exif_img.gps_latitude, exif_img.gps_latitude_ref)
                    lon = _dms_to_dd(exif_img.gps_longitude, exif_img.gps_longitude_ref)
                    report_item["coords"] = {"lat": lat, "lon": lon}
            else:
                print(f"  ðŸŸ¡ No EXIF data found for {path}.")
            
            processed_data.append(report_item)
        
        # Catch a broad exception as image files can be corrupt in many ways
        except Exception as e:
            print(f"  ðŸ”´ Could not process file {path}: {e}")
            
    return processed_data
